<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <CoreCompileDependsOn>Proto;$(CoreCompileDependsOn)</CoreCompileDependsOn>
  </PropertyGroup>
  <ItemGroup>
    <AvailableItemName Include="Proto"/>
  </ItemGroup>
  <Target Name="Proto" Inputs="@(Proto)" Outputs="@(Proto->'$(IntermediateOutputPath)%(FileName).cs')">
    <!-- Run our platform independent wrapper that launches protoc with the right arguments -->
    <Exec Condition="'$(OS)' == 'Windows_NT'" Command="$(MSBuildThisFileDirectory)..\tools\Grpc.Tools.CSharpGenerator.exe $(ProjectDir) $(IntermediateOutputPath) @(Proto->'%(filename)%(extension)', ' ')" LogStandardErrorAsError="true"/>
    
    <!-- Make sure that our protoc and protoc_csharp_plugin files are executable -->
    <Exec Condition="'$(OS)' == 'Unix'" Command="chmod +x $(MSBuildThisFileDirectory)../tools/*/protoc"/>
    <Exec Condition="'$(OS)' == 'Unix'" Command="chmod +x $(MSBuildThisFileDirectory)../tools/*/grpc_csharp_plugin"/>    

    <!-- Run our platform independent wrapper that launches protoc with the right arguments -->
    <Exec Condition="'$(OS)' == 'Unix'" Command="mono $(MSBuildThisFileDirectory)../tools/Grpc.Tools.CSharpGenerator.exe $(ProjectDir) $(IntermediateOutputPath) @(Proto->'%(filename)%(extension)', ' ')" LogStandardErrorAsError="true"/>
    
    <!-- Remove duplicate cs files that may be included because of proto includes + csharp generation -->
    <RemoveDuplicates Inputs="@(Proto->'$(IntermediateOutputPath)%(FileName)*.cs')">
        <Output TaskParameter="Filtered" ItemName="FilteredCSFiles"/>
    </RemoveDuplicates>
  </Target>
  <ItemGroup>
    <Compile Include="@(FilteredCSFiles)" >
      <CopyToOutputDirectory>Never</CopyToOutputDirectory>
    </Compile>
  </ItemGroup>
</Project>